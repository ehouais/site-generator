<%#
githubPwdStorageId
dbGistIdStorageId
mlabApiKeyStorageId
cipherKeyStorageId
%>
var match,
    str;

if (match = data.match(/^data:([^,;]+)(;[^,]+)?,(.*)/)) {
    str = decodeURIComponent(match[3]);
    if (match[1] == 'text/csv') {
        str = str.replace(/;/g, '\n');
    }
    parse(str, update);
} else if (data.match(/^https?:/)) {
    require(['http', 'on-demand', 'crypto'], function(Http, OnDemand, crypto) {
        var uri = data,
            cipherKey = OnDemand(sessionStorage, '<%- cipherKeyStorageId %>');

        Http.get(uri, function(data) {
            parse(crypto.decipher(cipherKey(), data), update);
        }, true);
    });
} else if (match = data.match(/mg\/(.+)/)) {
    require(['mlab-db', 'on-demand', 'crypto'], function(MlabDb, OnDemand, crypto) {
        var id = match[1],
            apiKey = OnDemand(localStorage, '<%- mlabApiKeyStorageId %>'),
            db = MlabDb({apikey: apiKey(), database: 'misc', collection: 'webviews'}),
            cipherKey = OnDemand(sessionStorage, '<%- cipherKeyStorageId %>');

        db.get({query: {id: id}, unique: true}, function(data) {
            parse(crypto.decipher(cipherKey(), JSON.stringify(data.value)), update);
        });
    });
} else if (match = data.match(/db\/(.+)/)) {
    require(['gist-db', 'on-demand', 'crypto'], function(GistDb, OnDemand, crypto) {
        var id = match[1],
            githubPwd = OnDemand(sessionStorage, '<%- githubPwdStorageId %>'),
            dbGistId = OnDemand(localStorage, '<%- dbGistIdStorageId %>'),
            db = GistDb({gistid: dbGistId(), user: 'ehouais', password: githubPwd()}),
            cipherKey = OnDemand(sessionStorage, '<%- cipherKeyStorageId %>');

        db.get(id, function(data) {
            parse(crypto.decipher(cipherKey(), data.content), update);
        });
    });
} else if (match = data.match(/gs\/(.+)/)) {
    require(['tabletop'], function(Tabletop) {
        Tabletop.init({
            key: 'https://docs.google.com/spreadsheets/d/'+match[1]+'/pubhtml',
            callback: function(data, tabletop) {
                var sheet = tabletop.models[tabletop.modelNames[0]]; // first sheet
                update({
                    cols: sheet.columnNames.map(function(name) {
                        return {label: name};
                    }),
                    rows: sheet.toArray()
                });
            },
            simpleSheet: true
        });
    });
} else {
    parse(data, update);
}
