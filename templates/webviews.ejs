<script src="//cdnjs.cloudflare.com/ajax/libs/require.js/2.3.2/require.min.js"></script>
<script>
    require.config({
        baseUrl: '//cdn.rawgit.com/ehouais/webviews/v0.4.0/tabs',
        paths: {
            http: '//cdn.rawgit.com/ehouais/js-data-libs/v0.5.0/http',
            sjcl: '//cdnjs.cloudflare.com/ajax/libs/sjcl/1.0.6/sjcl.min',
            'gist-fs': '//cdn.rawgit.com/ehouais/js-data-libs/v0.5.0/gist-fs',
            'on-demand': '//cdn.rawgit.com/ehouais/js-data-libs/v0.5.0/on-demand',
            crypto: '//cdn.rawgit.com/ehouais/js-data-libs/v0.5.0/crypto'
        },
        shim: {sjcl: {exports: 'sjcl'}},
        config: {
            text: {
                useXhr: function(url, protocol, hostname, port) {
                    return true; // force use of CORS for text dependencies
                }
            }
        }
    });

    var param = (function(uri) {
            var a = document.createElement('a');
            a.href = uri;
            return a.search.replace(/^\?/, '').split('&').reduce(function(obj, pair) {
                var tokens = pair.split('=');
                obj[tokens[0]] = decodeURIComponent(tokens[1]);
                return obj;
            }, {});
        })(window.location.href).data,
        match = param.match(/db\/(.+)/),
        id = match[1];

    Webviews = (function() {
        var handler,
            debounce = function(func, wait, immediate) {
                var timeout;
                return function() {
                    var context = this, args = arguments;
                    var later = function() {
                        timeout = null;
                        if (!immediate) func.apply(context, args);
                    };
                    var callNow = immediate && !timeout;
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                    if (callNow) func.apply(context, args);
                };
            },
            load = function() {
                require(['gist-fs', 'on-demand', 'crypto'], function(GistFs, OnDemand, crypto) {
                    var githubPwd = OnDemand(sessionStorage, '<%- githubPwdStorageId %>'),
                        dbGistId = OnDemand(localStorage, '<%- dbGistIdStorageId %>'),
                        fs = GistFs('ehouais', githubPwd(), dbGistId()),
                        cipherKey = OnDemand(sessionStorage, '<%- cipherKeyStorageId %>');

                    fs.get(id, function(data) {
                        handler(crypto.decipher(cipherKey(), data.content));
                    });
                });
            },
            save = debounce(function(data) {
                require(['gist-fs', 'on-demand', 'crypto'], function(GistFs, OnDemand, crypto) {
                    var githubPwd = OnDemand(sessionStorage, '<%- githubPwdStorageId %>'),
                        dbGistId = OnDemand(localStorage, '<%- dbGistIdStorageId %>'),
                        fs = GistFs('ehouais', githubPwd(), dbGistId()),
                        cipherKey = OnDemand(sessionStorage, '<%- cipherKeyStorageId %>');

                    fs.update(id, crypto.cipher(cipherKey(), data), function() {
                        console.log('saved.');
                        handler(data);
                    });
                });
            }, 5000),
            data = {
                bind: function(cb) {
                    handler = cb;
                    load();
                },
                save: save,
                trigger: function() {}
            };

        return {
            data: function() {
                return data;
            }
        }
    })();
</script>
